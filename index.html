<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>‚àû Lofi Radio</title>
  <link rel="icon" href="image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéß</text></svg>">
  <style>
    :root {
      --bg-gradient: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
      --text-color: #f0f0f0;
      --card-bg: rgba(30, 30, 46, 0.7);
      --btn-bg: #ff6f61;
      --btn-hover: #ff523d;
      --track-bg: rgba(255,255,255,0.1);
      --track-border: rgba(255,255,255,0.15);
      --track-active: rgba(255,111,97,0.3);
      --input-bg: rgba(0,0,0,0.2);
      --shadow: 0 10px 30px rgba(0,0,0,0.4);
    }

    .light-theme {
      --bg-gradient: linear-gradient(135deg, #f5f7fa, #e4edf9, #d1e0f5);
      --text-color: #2d3748;
      --card-bg: rgba(255, 255, 255, 0.85);
      --btn-bg: #4a6cf7;
      --btn-hover: #3a56d4;
      --track-bg: rgba(0,0,0,0.05);
      --track-border: rgba(0,0,0,0.1);
      --track-active: rgba(74, 108, 247, 0.2);
      --input-bg: rgba(0,0,0,0.03);
      --shadow: 0 6px 20px rgba(0,0,0,0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: var(--bg-gradient);
      color: var(--text-color);
      font-family: 'Segoe UI', system-ui, sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }

    body::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 30%, rgba(255,255,255,0.03) 0%, transparent 40%),
        radial-gradient(circle at 80% 70%, rgba(255,255,255,0.02) 0%, transparent 50%);
      animation: float 25s infinite ease-in-out;
      z-index: -1;
      opacity: 0.8;
    }

    .light-theme body::before {
      background: 
        radial-gradient(circle at 20% 30%, rgba(0,0,0,0.02) 0%, transparent 40%),
        radial-gradient(circle at 80% 70%, rgba(0,0,0,0.01) 0%, transparent 50%);
    }

    @keyframes float {
      0%, 100% { transform: translate(0, 0); }
      25% { transform: translate(-8px, -8px); }
      50% { transform: translate(8px, -4px); }
      75% { transform: translate(-4px, 8px); }
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      text-align: center;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    h1 {
      font-size: 1.8rem;
      font-weight: 700;
    }

    #theme-toggle {
      background: var(--track-bg);
      border: 1px solid var(--track-border);
      width: 44px;
      height: 44px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }

    #theme-toggle:hover {
      background: var(--track-active);
    }

    #player-container {
      width: 100%;
      aspect-ratio: 16 / 9;
      max-width: 640px;
      margin: 15px auto;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: var(--shadow);
      background: var(--card-bg);
      backdrop-filter: blur(10px);
    }

    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    #play-btn {
      padding: 12px 28px;
      font-size: 1.1rem;
      background: var(--btn-bg);
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      margin-top: 15px;
      box-shadow: 0 4px 12px rgba(255,111,97,0.3);
    }

    .light-theme #play-btn {
      box-shadow: 0 4px 12px rgba(74, 108, 247, 0.3);
    }

    #play-btn:hover {
      background: var(--btn-hover);
      transform: scale(1.04);
    }

    .controls {
      margin-top: 15px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      align-items: center;
    }

    .volume-control, .sleep-timer {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #volume-slider {
      width: 120px;
      height: 6px;
      -webkit-appearance: none;
      background: var(--track-border);
      border-radius: 3px;
      outline: none;
    }

    #volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--btn-bg);
      cursor: pointer;
    }

    #sleep-select {
      padding: 6px 10px;
      background: var(--input-bg);
      color: var(--text-color);
      border: 1px solid var(--track-border);
      border-radius: 8px;
      font-size: 0.95rem;
    }

    #custom-minutes {
      width: 60px;
      padding: 6px;
      background: var(--input-bg);
      color: var(--text-color);
      border: 1px solid var(--track-border);
      border-radius: 8px;
      font-size: 0.95rem;
      text-align: center;
    }

    #countdown {
      margin-top: 8px;
      font-size: 0.85rem;
      color: #aaa;
      min-height: 1.2em;
    }

    .add-track {
      margin: 25px 0;
      padding: 15px;
      background: var(--card-bg);
      border-radius: 16px;
      backdrop-filter: blur(8px);
    }

    .add-track h3 {
      margin-bottom: 12px;
      font-size: 1.2rem;
    }

    #custom-url {
      width: 100%;
      max-width: 400px;
      padding: 10px 14px;
      background: var(--input-bg);
      border: 1px solid var(--track-border);
      border-radius: 12px;
      color: var(--text-color);
      font-size: 1rem;
      margin-bottom: 10px;
    }

    #add-btn {
      padding: 8px 20px;
      background: var(--btn-bg);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 0.95rem;
    }

    #add-btn:hover {
      background: var(--btn-hover);
    }

    .tracks-section {
      margin-top: 20px;
    }

    .section-title {
      margin: 20px 0 12px;
      font-size: 1.1rem;
      opacity: 0.8;
    }

    .tracks, .custom-tracks {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
      padding: 0 10px;
    }

    .track-btn {
      padding: 8px 14px;
      background: var(--track-bg);
      color: var(--text-color);
      border: 1px solid var(--track-border);
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9rem;
      white-space: nowrap;
    }

    .custom-track-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--track-bg);
      border: 1px solid var(--track-border);
      border-radius: 12px;
      padding: 8px 12px;
      cursor: pointer;
      max-width: 280px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .custom-track-btn img {
      width: 40px;
      height: 24px;
      object-fit: cover;
      border-radius: 4px;
      flex-shrink: 0;
    }

    .custom-track-btn span {
      flex: 1;
      text-align: left;
      font-size: 0.85rem;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .delete-btn {
      background: none;
      border: none;
      color: #ff6b6b;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0;
      margin-left: 6px;
      flex-shrink: 0;
    }

    .track-btn:hover, .track-btn.active,
    .custom-track-btn:hover, .custom-track-btn.active {
      background: var(--track-active);
      border-color: var(--btn-bg);
    }

    .note {
      margin-top: 25px;
      font-size: 0.8rem;
      color: var(--text-color);
      opacity: 0.7;
      line-height: 1.5;
    }

    @media (max-width: 600px) {
      h1 { font-size: 1.5rem; }
      #player-container { border-radius: 12px; }
      .track-btn { padding: 7px 12px; font-size: 0.85rem; }
      .custom-track-btn { max-width: 220px; padding: 7px 10px; }
      .custom-track-btn img { width: 36px; height: 22px; }
      #play-btn { font-size: 1rem; padding: 10px 24px; }
      .controls { flex-direction: column; gap: 12px; }
      #volume-slider { width: 150px; }
      #custom-url { font-size: 0.95rem; }
    }
  </style>
</head>
<body class="dark-theme">
  <div class="container">
    <header>
      <h1>‚àû Lofi Radio</h1>
      <button id="theme-toggle" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">üåì</button>
    </header>

    <div id="player-container">
      <iframe id="lofi-player" 
              src="https://www.youtube.com/embed/jfKfPfyJRdk?autoplay=1&loop=1&playlist=jfKfPfyJRdk&controls=1&mute=1&enablejsapi=1"
              allow="autoplay; encrypted-media"
              title="Lofi Girl Radio">
      </iframe>
    </div>

    <button id="play-btn">‚ñ∂ –í–∫–ª—é—á–∏—Ç—å –º—É–∑—ã–∫—É</button>

    <div class="controls">
      <div class="volume-control">
        <span>üîà</span>
        <input type="range" id="volume-slider" min="0" max="100" value="10">
        <span>üîä</span>
      </div>

      <div class="sleep-timer">
        <label for="sleep-select">–¢–∞–π–º–µ—Ä:</label>
        <select id="sleep-select">
          <option value="0">–ù–∏–∫–æ–≥–¥–∞</option>
          <option value="900">15 –º–∏–Ω</option>
          <option value="1800">30 –º–∏–Ω</option>
          <option value="2700">45 –º–∏–Ω</option>
          <option value="3600">60 –º–∏–Ω</option>
          <option value="custom">–°–≤–æ—ë –≤—Ä–µ–º—è</option>
        </select>
        <input type="number" id="custom-minutes" min="1" max="240" value="30" placeholder="–º–∏–Ω" style="display: none;">
      </div>
    </div>

    <div id="countdown"></div>

    <div class="add-track">
      <h3>‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–π —Å—Ç—Ä–∏–º</h3>
      <input type="text" id="custom-url" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É YouTube" />
      <br>
      <button id="add-btn">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>

    <div class="tracks-section">
      <div class="section-title">üéß –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–∏–º—ã</div>
      <div class="tracks">
        <button class="track-btn active" data-id="jfKfPfyJRdk">Study Beats</button>
        <button class="track-btn" data-id="5qap5aO4i9A">Chillhop Radio</button>
        <button class="track-btn" data-id="rUxyKA_-grg">Lofi Mix</button>
        <button class="track-btn" data-id="lTRiuFIWV54">Rainy Mood</button>
        <button class="track-btn" data-id="DRFHklnN-SM">LoFi Dreams</button>
        <button class="track-btn" data-id="IxPANmjPaek">Night Study</button>
      </div>
    </div>

    <div class="tracks-section">
      <div class="section-title">üìÅ –ú–æ–∏ —Å—Ç—Ä–∏–º—ã</div>
      <div class="custom-tracks" id="custom-tracks-container">
        <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ç—Ä–µ–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å -->
      </div>
    </div>

    <p class="note">
      –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Å—Å—ã–ª–∫–∏: https://youtube.com/watch?v=... –∏–ª–∏ https://youtu.be/...
    </p>
  </div>

  <script>
    // === –¢–µ–º–∞ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö) ===
    const body = document.body;
    const themeToggle = document.getElementById('theme-toggle');
    const savedTheme = localStorage.getItem('lofi-theme') || 'dark';
    
    if (savedTheme === 'light') {
      body.classList.replace('dark-theme', 'light-theme');
      themeToggle.textContent = 'üåô';
    } else {
      body.classList.replace('light-theme', 'dark-theme');
      themeToggle.textContent = 'üåì';
    }

    themeToggle.addEventListener('click', () => {
      if (body.classList.contains('light-theme')) {
        body.classList.replace('light-theme', 'dark-theme');
        localStorage.setItem('lofi-theme', 'dark');
        themeToggle.textContent = 'üåì';
      } else {
        body.classList.replace('dark-theme', 'light-theme');
        localStorage.setItem('lofi-theme', 'light');
        themeToggle.textContent = 'üåô';
      }
    });

    // === –¢–∞–π–º–µ—Ä —Å–Ω–∞ —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º ===
    let sleepTimeout = null;
    let sleepEndTime = null;
    const sleepSelect = document.getElementById('sleep-select');
    const customMinutesInput = document.getElementById('custom-minutes');
    const countdownEl = document.getElementById('countdown');

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
    }

    function updateCountdown() {
      if (!sleepEndTime) {
        countdownEl.textContent = '';
        return;
      }

      const now = Date.now();
      const diff = Math.max(0, Math.floor((sleepEndTime - now) / 1000));
      
      if (diff <= 0) {
        stopMusicForSleep();
        return;
      }

      countdownEl.textContent = `üí§ –ú—É–∑—ã–∫–∞ –≤—ã–∫–ª—é—á–∏—Ç—Å—è —á–µ—Ä–µ–∑: ${formatTime(diff)}`;
      setTimeout(updateCountdown, 1000);
    }

    function stopMusicForSleep() {
      sendPlayerCommand('stopVideo');
      countdownEl.textContent = 'üí§ –ú—É–∑—ã–∫–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞ –ø–æ —Ç–∞–π–º–µ—Ä—É';
      sleepEndTime = null;
    }

    function setSleepTimer(seconds) {
      if (sleepTimeout) clearTimeout(sleepTimeout);
      if (seconds <= 0) {
        sleepEndTime = null;
        countdownEl.textContent = '';
        return;
      }

      sleepEndTime = Date.now() + seconds * 1000;
      updateCountdown();
    }

    sleepSelect.addEventListener('change', () => {
      if (sleepSelect.value === 'custom') {
        customMinutesInput.style.display = 'inline-block';
        customMinutesInput.focus();
        // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        const mins = parseInt(customMinutesInput.value) || 30;
        setSleepTimer(mins * 60);
      } else {
        customMinutesInput.style.display = 'none';
        const seconds = parseInt(sleepSelect.value);
        setSleepTimer(seconds);
      }
    });

    customMinutesInput.addEventListener('input', () => {
      let mins = parseInt(customMinutesInput.value) || 0;
      mins = Math.min(Math.max(mins, 1), 240); // –æ—Ç 1 –¥–æ 240 –º–∏–Ω—É—Ç
      customMinutesInput.value = mins;
      setSleepTimer(mins * 60);
    });

    // === –ü–ª–µ–µ—Ä –∏ –≥—Ä–æ–º–∫–æ—Å—Ç—å ===
    const player = document.getElementById('lofi-player');
    const playBtn = document.getElementById('play-btn');
    const volumeSlider = document.getElementById('volume-slider');
    let isMuted = true;
    let lastVolume = 10;
    let currentTrackId = 'jfKfPfyJRdk';

    function sendPlayerCommand(func, args = []) {
      const command = JSON.stringify({
        event: 'command',
        func: func,
        args: args
      });
      player.contentWindow.postMessage(command, '*');
    }

    function updatePlayerVolume(volume) {
      sendPlayerCommand('setVolume', [Math.round(volume * 100)]);
    }

    playBtn.addEventListener('click', () => {
      isMuted = false;
      lastVolume = parseInt(volumeSlider.value) || 10;

      player.src = `https://www.youtube.com/embed/${currentTrackId}?autoplay=1&loop=1&playlist=${currentTrackId}&controls=1&enablejsapi=1`;

      setTimeout(() => {
        sendPlayerCommand('playVideo');
        updatePlayerVolume(lastVolume / 100);
      }, 800);

      playBtn.style.display = 'none';
    });

    volumeSlider.addEventListener('input', () => {
      if (!isMuted) {
        const vol = volumeSlider.value / 100;
        lastVolume = volumeSlider.value;
        updatePlayerVolume(vol);
      }
    });

    // === –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–∫–∞–º–∏ ===
    const officialButtons = document.querySelectorAll('.track-btn');
    const customTracksContainer = document.getElementById('custom-tracks-container');

    function loadCustomTracks() {
      const saved = localStorage.getItem('lofi-custom-tracks');
      const tracks = saved ? JSON.parse(saved) : [];
      renderCustomTracks(tracks);
    }

    function saveCustomTracks(tracks) {
      localStorage.setItem('lofi-custom-tracks', JSON.stringify(tracks));
    }

    function renderCustomTracks(tracks) {
      customTracksContainer.innerHTML = '';
      tracks.forEach((track, index) => {
        const btn = document.createElement('div');
        btn.className = 'custom-track-btn';
        if (currentTrackId === track.id) btn.classList.add('active');
        btn.innerHTML = `
          <img src="${track.thumbnail}" alt="thumbnail">
          <span>${track.title || track.id}</span>
          <button class="delete-btn" data-index="${index}">√ó</button>
        `;
        btn.dataset.id = track.id;
        btn.addEventListener('click', (e) => {
          if (!e.target.classList.contains('delete-btn')) {
            switchTrack(track.id);
          }
        });
        customTracksContainer.appendChild(btn);
      });

      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const index = parseInt(btn.dataset.index);
          const tracks = JSON.parse(localStorage.getItem('lofi-custom-tracks') || '[]');
          tracks.splice(index, 1);
          saveCustomTracks(tracks);
          loadCustomTracks();
        });
      });
    }

    function extractVideoId(url) {
      const regExp = /^.*(youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
      const match = url.match(regExp);
      return (match && match[2].length === 11) ? match[2] : null;
    }

    async function fetchVideoInfo(videoId) {
      try {
        const oembedUrl = `https://www.youtube.com/oembed?url=https://youtu.be/${videoId}&format=json`;
        const response = await fetch(oembedUrl);
        if (!response.ok) throw new Error('–í–∏–¥–µ–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
        const data = await response.json();
        return {
          id: videoId,
          title: data.title || videoId,
          thumbnail: `https://i.ytimg.com/vi/${videoId}/mqdefault.jpg`
        };
      } catch (err) {
        return {
          id: videoId,
          title: videoId,
          thumbnail: `https://i.ytimg.com/vi/${videoId}/mqdefault.jpg`
        };
      }
    }

    document.getElementById('add-btn').addEventListener('click', async () => {
      let input = document.getElementById('custom-url').value.trim();
      if (!input) return;

      let videoId = extractVideoId(input) || (input.length === 11 && /^[a-zA-Z0-9_-]+$/.test(input) ? input : null);
      if (!videoId) {
        alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å—Å—ã–ª–∫–∏.');
        return;
      }

      const tracks = JSON.parse(localStorage.getItem('lofi-custom-tracks') || '[]');
      if (tracks.some(t => t.id === videoId)) {
        alert('–≠—Ç–æ—Ç —Å—Ç—Ä–∏–º —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω!');
        return;
      }

      const info = await fetchVideoInfo(videoId);
      tracks.push(info);
      saveCustomTracks(tracks);
      loadCustomTracks();
      document.getElementById('custom-url').value = '';
    });

    function switchTrack(videoId) {
      currentTrackId = videoId;
      const muteParam = isMuted ? 'mute=1' : 'mute=0';
      player.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&loop=1&playlist=${videoId}&controls=1&${muteParam}&enablejsapi=1`;

      officialButtons.forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.custom-track-btn').forEach(b => b.classList.remove('active'));
      const activeBtn = document.querySelector(`.custom-track-btn[data-id="${videoId}"]`);
      if (activeBtn) activeBtn.classList.add('active');

      if (!isMuted) {
        setTimeout(() => {
          sendPlayerCommand('playVideo');
          updatePlayerVolume(lastVolume / 100);
        }, 800);
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    loadCustomTracks();

    officialButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        switchTrack(btn.dataset.id);
      });
    });
  </script>
</body>
</html>
